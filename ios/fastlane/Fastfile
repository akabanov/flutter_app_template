# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

default_platform(:ios)

platform :ios do

  before_all do
    if ENV['APP_STORE_CONNECT_PRIVATE_KEY']
      # CI
      app_store_connect_api_key(
        key_id: ENV['APP_STORE_CONNECT_KEY_IDENTIFIER'],
        issuer_id: ENV['APP_STORE_CONNECT_ISSUER_ID'],
        key_content: ENV['APP_STORE_CONNECT_PRIVATE_KEY'])
    else
      # Dev workstation
      ENV['FASTLANE_PASSWORD'] = File.read(ENV['ITUNES_PASSWORD_PATH'])
      ENV['SENTRY_AUTH_TOKEN'] = File.read(ENV['SENTRY_CI_TOKEN_PATH'])
      app_store_connect_api_key(
        key_id: ENV['APP_STORE_CONNECT_KEY_IDENTIFIER'],
        issuer_id: ENV['APP_STORE_CONNECT_ISSUER_ID'],
        key_filepath: ENV['APP_STORE_CONNECT_PRIVATE_KEY_PATH'])
    end
  end

  lane :create do
    produce(
      company_name: ENV['APP_STORE_COMPANY_NAME'],
      app_name: ENV['APP_NAME_DISPLAY'],
      language: ENV['PRIMARY_APP_LANGUAGE'],
      sku: ENV['APP_TIMESTAMP'],
      app_version: '1.0', # default one, don't mess with it: https://github.com/fastlane/fastlane/issues/18794
    )
    upload_app_privacy_details_to_app_store(
      json_path: "fastlane/initial_app_privacy.json")
  end

  lane :deploy_meta do
    Dir.chdir("../..") do
      sh "flutter test --update-goldens --tags=screenshots-ios"
    end
    deliver(skip_binary_upload:true)
  end

  lane :build do
    Dir.chdir("../..") do
      sh "shorebird release ios --split-debug-info=build/app/outputs/symbols"
    end
  end

  lane :beta do
    build
    deploy_meta
    # upload_to_testflight
    Dir.chdir("../..") do
      sh "dart run sentry_dart_plugin"
      # Alternatively:
      # sh "flutter packages pub run sentry_dart_plugin"
    end
  end

  # lane :deploy_appstore do
  # end

end
